<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/reset.css" />
    <link rel="stylesheet" href="../주석없는 ver./noDesc.css" />
    <title>Document</title>
  </head>
  <body>
    <header>
      <h1>최고 평점 영화 콜렉션</h1>
    </header>

    <form id="form">
      <label for="search-input">영화 검색 : </label>
      <input id="search-input" type="text" placeholder="영화 제목을 검색해 보세요" autofocus />
      <button type="submit" id="searchMovie">검색</button>

      <audio id="audio" controls loop>
        <source src="../audio/little_dramatic.mp3" />
        <source src="../audio/backgroundMusic.mp3" />
      </audio>
    </form>

    <button class="scrollUp" onclick="window.scrollTo(0,0)">⬆︎</button>

    <section id="cards">
      <div class="card-bg">
        <div class="card-content">
          <img src="https://image.tmdb.org/t/p/w500/q6y0Go1tsGEsmtFryDOJo3dEmqu.jpg" alt="movie image" />
          <h3>movie title</h3>
          <p class="card-overview">
            overview : Lorem ipsum dolor sit amet consectetur adipisicing elit. Eum iste voluptas labore adipisci omnis
            sint debitis, consequuntur earum et quasi aut ducimus. Enim ad, sapiente dignissimos amet voluptate quidem
            commodi Lorem ipsum dolor sit amet consectetur adipisicing elit. Pariatur labore modi mollitia tempora
            aspernatur ea, veritatis illum vero nobis iure animi in quis quidem consequuntur, quisquam nostrum maxime
            aliquam neque.
          </p>
          <p class="card-rating">rating 8.5</p>
        </div>
      </div>
    </section>

    <script>
      window.onload = function () {
        getMovieAPI();
      };

      function alertId(movieId) {
        alert(`영화 id : ${movieId}`);
      }

      const options = {
        method: 'GET',
        headers: {
          accept: 'application/json',
          Authorization:
            'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJhYjdkNzRhNTRiYzEzNTE4ZDgyMTc1MjAzNzM4MzliNSIsInN1YiI6IjY0NzA4OGI1NTQzN2Y1MDE0NzVmMDU0ZSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.FaD0cXTgqDH5QUE4-ZoUBQJFr9fuQMr0VtpdOJEbTxE',
        },
      };

      function getMovieAPI() {
        fetch('https://api.themoviedb.org/3/movie/top_rated?language=en-US&page=1', options)
          .then(response => response.json())
          .then(json => {
            console.log(json);
            displayItems(json);
          })
          .catch(err => console.error(err));
      }

      function displayItems(movieInfos) {
        let movies = movieInfos['results'];

        let parent = document.getElementsByTagName('section')[0];
        let children = parent.querySelectorAll('.card-bg');

        children.forEach(child => {
          parent.removeChild(child);
        });

        movies.forEach(movie => {
          let id = movie['id'];
          let title = movie['title'];
          let overview = movie['overview'];
          let poster_path = 'https://image.tmdb.org/t/p/w500' + movie['poster_path'];
          let vote_average = movie['vote_average'];
          let temp_html = `
          <div class="card-bg">
            <div id="${id}" class="card-content" onclick="alertId(this.id)">
              <!-- 이미지 크기 260*390 -->
              <img src="${poster_path}" alt="movie image" />
              <h3>${title}</h3>
              <p class="card-overview">
                ${overview}
              </p>
              <p class="card-rating">Rating : ${vote_average}</p>
            </div>
          </div>
          `;

          document.getElementsByTagName('section')[0].insertAdjacentHTML('beforeend', temp_html);

          function showSearch(event) {
            event.preventDefault();

            let input_str = document.getElementById('search-input').value; // DOM의 속성 value를 이용해서 해당 요소의 값을 가져오기
            console.log(input_str);

            let parent = document.getElementsByTagName('section')[0];
            let children = parent.querySelectorAll('.card-bg');

            children.forEach(child => {
              parent.removeChild(child);
            });

            movies.forEach(movie => {
              let title = movie['title'];

              let sTitle = title.toLowerCase();
              let sInput_str = input_str.toLowerCase();

              if (sTitle.includes(sInput_str)) {
                let id = movie['id'];
                let overview = movie['overview'];
                let poster_path = 'https://image.tmdb.org/t/p/w500' + movie['poster_path'];
                let vote_average = movie['vote_average'];
                let temp_html = `
                              <div class="card-bg">
                                <div id="${id}" class="card-content" onclick="alertId(this.id)">
                                  <!-- 이미지 크기 260*390 -->
                                  <img src="${poster_path}" alt="movie image" />
                                  <h3>${title}</h3>
                                  <p class="card-overview">
                                    ${overview}
                                  </p>
                                  <p class="card-rating">Rating : ${vote_average}</p>
                                </div>
                              </div>
                              `;
                document.getElementById('cards').insertAdjacentHTML('beforeend', temp_html);
              }
            });
          }

          document.getElementById('form').addEventListener('submit', showSearch);
        });
      }
    </script>
  </body>
</html>
